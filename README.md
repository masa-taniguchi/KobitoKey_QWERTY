# KobitoKey_QWERTY

小人キー（KobitoKey）のZMKファームウェアリポジトリです。

## ブランチ構成と仕様

このプロジェクトは、**mainブランチ**と**developブランチ**の2つのブランチで管理されています。

### mainブランチ（安定版）

**用途**: 安定した動作が確認された最終版のファームウェア

**主な仕様**:
- ZMK v0.3ベース
- 左側トラックボール: 常時スクロール機能
- 右側トラックボール: 常時ポインティング機能
- 基本的なレイヤー構成（Layer 0-4）
- 安定性を重視した設定

**推奨用途**:
- 日常的な使用
- 安定した動作が必要な場合
- 本番環境での使用

### developブランチ（開発版）

**用途**: 新機能の開発とテスト用のファームウェア

**主な仕様**:
- ZMK mainブランチベース（最新機能）
- 左側トラックボール: 常時スクロール機能（左右のみ反転）
- 右側トラックボール: 
  - デフォルト: ポインティング機能
  - Layer 3時: スクロール機能（上下左右反転）
- 最新のZMK機能を活用した設定
- トラックボールの感度調整や角度調整が最適化済み

**推奨用途**:
- 新機能のテスト
- 最新機能の試用
- 開発・実験的な使用

**注意事項**:
- developブランチは開発中であるため、動作が不安定な場合があります
- 本番環境での使用は推奨しません

## レイヤー構成

Layer 0 QWERTY
<img width="1280" height="690" alt="Image" src="https://github.com/user-attachments/assets/ef0797b7-a63f-4632-912d-9b5d0115769f" />

Layer 1 NUMBER & ARROW
<img width="1280" height="690" alt="Image" src="https://github.com/user-attachments/assets/d6347b3c-a238-4278-bacd-e58195774d0e" />

Layer 2 Bluetooth & FUNCTION
<img width="1280" height="690" alt="Image" src="https://github.com/user-attachments/assets/f1f7cc93-fbd8-4a98-84ea-c8c36ad3952d" />

Layer 3 AUTO MOUSE
<img width="1280" height="690" alt="Image" src="https://github.com/user-attachments/assets/2efe5275-e460-41bc-ae45-0c0665435268" />

## 無線接続（Bluetooth）の設定手順

ZMKファームウェアを使用する場合、初回接続時や接続が切れた場合にBluetoothのペアリング手続きが必要です。

### 初回ペアリング手順

1. **キーボードを起動**
   - 左右両方のキーボードに電源を供給
   - 左側（セントラル）と右側（ペリフェラル）が自動的に接続されるのを待つ

2. **Bluetoothプロファイルを選択**
   - Layer 3（MOUSEレイヤー）に切り替え
   - 右上のキーを押してBluetoothプロファイルを選択：
     - 右上から2番目: `BT_SEL 0`（プロファイル0）
     - 右上: `BT_SEL 1`（プロファイル1）
     - 右中央上: `BT_SEL 2`（プロファイル2）
     - 右中央下: `BT_SEL 3`（プロファイル3）

3. **PC/デバイスでペアリング**
   - PCやスマートフォンのBluetooth設定を開く
   - 「KobitoKey」という名前のデバイスを検索
   - ペアリングを実行

### 再接続手順（接続が切れた場合）

1. **Bluetoothプロファイルを再選択**
   - Layer 3に切り替え
   - 使用したいプロファイルのキーを押す（例: `BT_SEL 0`）

2. **PC/デバイス側で再接続**
   - PCやスマートフォンのBluetooth設定で「KobitoKey」を選択
   - 接続を試みる

### すべてのBluetooth設定をリセットする場合

1. **設定リセットファームウェアを使用**
   - `build.yaml`に`settings_reset`シールドが含まれています
   - このファームウェアを書き込むと、すべてのBluetooth設定がリセットされます

2. **キーボード操作でリセット**
   - Layer 3に切り替え
   - 右中央下から2番目のキー（`BT_CLR`）を押すと、現在のプロファイルがクリアされます
   - 右中央下のキー（`BT_CLR_ALL`）を押すと、すべてのプロファイルがクリアされます

### トラブルシューティング

**問題**: 接続できない、または接続がすぐに切れる

**解決方法**:
1. キーボードの電源を確認（バッテリー残量を確認）
2. PC/デバイスのBluetooth設定で「KobitoKey」を削除してから再ペアリング
3. `BT_CLR_ALL`で全プロファイルをクリアしてから再ペアリング
4. `settings_reset`ファームウェアを書き込んで完全にリセット

**問題**: 接続と未接続を繰り返す（接続が不安定）

**重要**: USB接続で安定して使用できている場合は、ハードウェアやファームウェアの基本的な動作には問題がなく、Bluetooth接続に特化した問題です。

この問題は、左右のキーボード間のBluetooth接続（split接続）またはPC/デバイスとのBluetooth接続が不安定な場合に発生します。以下の手順を順番に試してください：

1. **左右のキーボード間の接続を確認**
   - 左側（セントラル）と右側（ペリフェラル）の両方の電源を確認
   - 左側を先に起動し、5秒待ってから右側を起動
   - 左右が接続されるまで待つ（LEDの点滅パターンで確認可能）
   - 左右の接続が不安定だと、PCとの接続も不安定になります

2. **バッテリーを充電**
   - 左右両方のキーボードのバッテリーを充電
   - バッテリー残量が低いとBluetooth接続が不安定になることがあります
   - USB接続で充電しながら使用して動作を確認

3. **Bluetooth設定を完全にリセット**
   - Layer 3に切り替え
   - `BT_CLR_ALL`を押してすべてのプロファイルをクリア
   - PC/デバイスのBluetooth設定で「KobitoKey」を削除
   - `settings_reset`ファームウェアを書き込んで完全にリセット（推奨）
   - リセット後、左右を再起動してから再度ペアリング

4. **左右の起動順序を確認**
   - 必ず左側（セントラル）を先に起動
   - 左側が完全に起動してから（約5秒後）右側（ペリフェラル）を起動
   - この順序が重要です

5. **環境要因の確認**
   - 他のBluetoothデバイスとの干渉を確認（一時的に他のBluetoothデバイスをオフにする）
   - PC/デバイスをキーボードに近づける（1m以内）
   - 金属製の机や干渉源から離す
   - Wi-Fiルーターなどの2.4GHz帯のデバイスから離す

6. **ZMK設定の確認**
   - `CONFIG_ZMK_SPLIT_ROLE_CENTRAL=y`が左側に設定されているか確認
   - 右側にはこの設定がないことを確認
   - 左右のファームウェアのバージョンが一致しているか確認
   - 以下の設定が左右両方に追加されているか確認（最新のファームウェアに含まれています）：
     - `CONFIG_BT_CTLR_TX_PWR_PLUS_8=y`（Bluetooth送信電力を上げる）
     - `CONFIG_ZMK_SPLIT=y`（split keyboardサポートを有効化）
     - `CONFIG_ZMK_SPLIT_BLE=y`（split接続にBluetoothを使用）

7. **一時的な回避策**
   - USB接続で安定して使用できる場合は、当面USB接続を使用
   - Bluetooth接続の問題が解決するまで、USB接続で使用を継続

**問題**: 左右のキーボードが接続されない

**解決方法**:
1. 左右両方のキーボードの電源を確認
2. 左側（セントラル）を先に起動し、その後右側（ペリフェラル）を起動
3. ファームウェアを再書き込み
4. 左右のファームウェアのバージョンが一致しているか確認

**問題**: USB接続は動作するが、Bluetooth接続ができない

**解決方法**:
1. Bluetooth設定をリセット（`BT_CLR_ALL`）
2. PC/デバイスのBluetooth設定で「KobitoKey」を削除
3. `settings_reset`ファームウェアを書き込んで完全にリセット
4. 再度ペアリングを試みる
